name: PHP Common Bump
on:
  workflow_call:
    inputs:
      php_version:
        required: false
        type: string
        default: "8.3"
      commit_message:
        required: false
        type: string
        default: "chore: common bump"
      continue_on_error:
        required: false
        type: boolean
        default: false
    secrets:
      write_pat:
        required: true
      packagist_username:
        required: true
      packagist_password:
        required: true
    outputs:
      commit_sha:
        description: "The commit SHA after bump (new commit if changes, otherwise triggering commit)"
        value: ${{ jobs.upgrade-common.outputs.commit_sha }}

jobs:
  upgrade-common:
    name: Upgrade Common
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.continue_on_error }}
    outputs:
      commit_sha: ${{ steps.commit.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: "${{ secrets.write_pat }}"
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php_version }}
          tools: composer:v2
          coverage: none
      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      - name: Install dependencies
        env:
          COMPOSER_AUTH: '{"http-basic": {"repo.packagist.com": {"username": "${{ secrets.packagist_username }}", "password": "${{secrets.packagist_password}}"}}}'
        uses: nick-invision/retry@v1
        with:
          timeout_minutes: 5
          max_attempts: 5
          command: composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader --apcu-autoloader
      - name: Update Common
        env:
          COMPOSER_AUTH: '{"http-basic": {"repo.packagist.com": {"username": "${{ secrets.packagist_username }}", "password": "${{secrets.packagist_password}}"}}}'
        uses: nick-invision/retry@v1
        with:
          timeout_minutes: 5
          max_attempts: 5
          command: composer require revolutionparts/common --prefer-dist --no-interaction --no-progress --optimize-autoloader --apcu-autoloader
      - name: Commit Common Bump
        id: commit
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

          # Check if there are changes to commit
          if git diff-index --quiet HEAD; then
            echo "No changes to commit"
            echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
            exit 0
          fi

          git commit -am "${{ inputs.commit_message }} [skip actions]"

          # Push with retry logic to handle race conditions where main has moved
          MAX_ATTEMPTS=5
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Push attempt $ATTEMPT of $MAX_ATTEMPTS"

            # Fetch latest and rebase before pushing
            git fetch origin main
            if git rebase origin/main; then
              if git push origin main; then
                echo "Push succeeded on attempt $ATTEMPT"
                break
              fi
            else
              echo "Rebase failed, resetting and retrying..."
              git rebase --abort 2>/dev/null || true
            fi

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "Failed to push after $MAX_ATTEMPTS attempts"
              exit 1
            fi

            ATTEMPT=$((ATTEMPT + 1))
            sleep 2
          done

          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
